<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">



  <link rel="icon" type="image/png" sizes="32x32" href="/images/searchicon.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/searchicon.png?v=7.0.0">








<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","width":300,"display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Tony&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Tony&#39;s Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tony&#39;s Blog">






  <link rel="canonical" href="http://yoursite.com/page/6/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Tony's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tony's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
            
            
            
              
              

  
  
    
  
  <li class="menu-item menu-item-iot-jotting">

    
    
    
      
    

    

    <a href="/iot-misc/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>IoT Jotting</a>

  </li>


            
          
        
        
        
        
          
            
            
            
              
              

  
  
    
  
  <li class="menu-item menu-item-risc-jotting">

    
    
    
      
    

    

    <a href="/risc/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>RISC Jotting</a>

  </li>


            
          
        

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/16/coding/review/paho-mqtt-c-notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tony">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tony's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/08/16/coding/review/paho-mqtt-c-notes/" class="post-title-link" itemprop="url">Paho.mqtt.c library notes</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-16 20:43:20" itemprop="dateCreated datePublished" datetime="2018-08-16T20:43:20+08:00">2018-08-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-03-17 23:09:21" itemprop="dateModified" datetime="2020-03-17T23:09:21+08:00">2020-03-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Coding/" itemprop="url" rel="index"><span itemprop="name">Coding</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Coding/Review/" itemprop="url" rel="index"><span itemprop="name">Review</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Coding/Review/Paho-mqtt-C/" itemprop="url" rel="index"><span itemprop="name">Paho mqtt C</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Use-MQTT-client-library"><a href="#Use-MQTT-client-library" class="headerlink" title="Use MQTT client library"></a><strong>Use MQTT client library</strong></h4><p>In the library’s source code, there are implementations of Socket. The following content tries to figure out what APIs defined in Socket have been used in MQTTAsync.c.</p>
<p>To begin with, here’s a briefing of using MQTTAsync.c. An example could be found in ‘transport-mqtt’ plugin.</p>
<ol>
<li>When emberAfPluginTransportMqttInitCallback() is called by ember AF, a mutex would firstly be created for connection status.</li>
<li>In the same callback (i.e., emberAfPluginTransportMqttInitCallback), two MQTT methods are to be called to initialize MQTT comm. They are MQTTAsync_create() and MQTTAsync_setCallbacks().</li>
<li>A few callbacks or configurations are of the most interests. They are either been passed to MQTTAsync_setCallback(), or been set in mqttConnectOptions. One of them is <strong>mqttMessageArrivedCallback</strong> where MQTT message would be passed into another callback (i.e., <strong>emberAfPluginTransportMqttMessageArrivedCallback</strong>) whose implementation residing in gateway-relay-mqtt.c. Another configuration is keepAliveInterval, which I guess is to maintain the connection between the client and the broker.</li>
<li>In transport-mqtt.h, two APIs are provided: <strong>emberAfPluginTransportMqttSubscribe()</strong> and </li>
</ol>
<p><strong>emberAfPluginTransportMqttPublish()</strong>. They will be called by gateway-relay-mqtt.c.<br>5. emberAfPluginTransportMqttPublish() calls MQTTAsync_sendMessage defined in MQTTAsync.h.</p>
<hr>
<h4 id="MQTTAsync-and-Linux-Socket"><a href="#MQTTAsync-and-Linux-Socket" class="headerlink" title="MQTTAsync and Linux Socket"></a><strong>MQTTAsync and Linux Socket</strong></h4><p>We could see in the src folder that paho.mqtt.c implement Socket.c. The implementation provides wrapper functions for creating or closing TCP sockets, and for receiving and sending via a socket in a non-blocking fashion. Socket.c also allows multiple socket connection, which I guess such a feature could be used for local or remote server connections.</p>
<p>The APIs of most interests are:</p>
<ol>
<li><strong>Socket_new()</strong>: in which socket() method is called.</li>
<li><strong>Socket_close()</strong>: in which close() method is called.</li>
<li><strong>Socket_getdata()</strong> or <strong>Socket_getchar()</strong>: in which recv() method is used.</li>
<li><strong>Socket_putdatas()</strong>: calls an internal function Socket_writev().</li>
</ol>
<p>The internal functions of most interests are:</p>
<ol>
<li><strong>Socket_writev()</strong>: which eventually calls <em>writev()</em> functions defined in <em>sys/uio.h</em>.</li>
<li><strong>Socket_setnonblocking()</strong>: which calls <em>fcntl()</em> eventually.</li>
</ol>
<p>A description of readv() and writev() is as below:</p>
<blockquote>
<p>The data transfers performed by readv() and writev() are atomic: the data written by writev() is written as a single block that is not intermingled with output from writes in other processes (but see pipe(7) for an exception); analogously, readv() is guaranteed to read a contiguous block of data from the file, regardless of read operations performed in other threads or processes that have file descriptors referring to the same open file description (see open(2)).</p>
</blockquote>
<p>A code example shows combining two strings into one buffer and send them using writev().</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str0 = <span class="string">"hello "</span>;</span><br><span class="line">    <span class="keyword">char</span> *str1 = <span class="string">"world\n"</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[2];</span></span><br><span class="line">    <span class="keyword">ssize_t</span> nwritten;</span><br><span class="line"></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = str0;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = <span class="built_in">strlen</span>(str0);</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = str1;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = <span class="built_in">strlen</span>(str1);</span><br><span class="line"></span><br><span class="line">    nwritten = writev(STDOUT_FILENO, iov, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%ld bytes written.\n"</span>, nwritten);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Execution results:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ gcc writevex.c </span><br><span class="line">$ ./a.out </span><br><span class="line">hello world</span><br><span class="line">12 bytes written.</span><br></pre></td></tr></table></figure>

<p><strong>Here is the function call tracing for Socket_new()</strong>:</p>
<ul>
<li>Socket_new() is called by MQTTProtocol_connect() defined in MQTTProtocolOut.c.</li>
<li>MQTTProtocol_connect() is called by MQTTAsync_processCommand() defined in MQTTAsync.c, specifically in the case of CONNECT (command-&gt;command.type == CONNECT).</li>
<li>MQTTAsync_processCommand() is called by MQTTAsync_sendThread() defined in MQTTAsync.c. There are two threads created when start up. MQTTAsync_sendThread is one of them, and the other is MQTTAsync_receiveThread.</li>
</ul>
<p><strong>Here is the function call tracing for Socket_getdata()</strong>:</p>
<ul>
<li>Socket_getdata() is called by WebSocket_getRawSocketData() defined in WebSocket.c.</li>
<li>WebSocket_getRawSocketData() is a static function and is called mostly by WebSocket_receiveFrame() and WebSocket_upgrade() methods. Pick receiveFrame method as the next tracing function because the name makes more sense.</li>
<li>WebSocket_receiveFrame() is a static function which is called by either WebSocket_getdata() or WebSocket_getch().</li>
<li>WebSocket_getdata() is called by MQTTPacket_Factory() defined in MQTTPacket.c.</li>
<li>MQTTPacket_Factory() is called by either MQTTClient_cycle() defined in MQTTClient.c or MQTTAsync_cycle() defined in MQTTAsync.c. Both of them are static functions. Notice MQTTClient represents synchronous comm, while MQTTAsync represents asynchronous comm.</li>
<li><strong>MQTTAsync_cycle()</strong> is called within MQTTAsync_receiveThread().</li>
</ul>
<p><strong>Here is the function call tracing for Socket_putdatas()</strong>:</p>
<ul>
<li>Socket_putdatas() is called by multiple methods in WebSocket.c. One of them is of the most interest, which is WebSocket_putdatas().</li>
<li>WebSocket_putdatas() is called by MQTTPacket_send() and MQTTPacket_sends() methods in MQTTPacket.c, indicating sending one-byte or bytes respectively.</li>
<li>MQTTPacket_sends() is a static method, and is called by MQTTPacket_send_publish(). MQTTPacket_send() is a static method, and is called by MQTTPacket_send_disconnect(). We will focus on tracing MQTTPacket_send_publish().</li>
<li>MQTTPacket_send_publish() is called by static functions MQTTProtocol_startPublishCommon() and MQTTProtocol_retries() in MQTTProtocolClient.c.  </li>
<li>MQTTProtocol_startPublishCommon() is called by MQTTProtocol_startPublish().</li>
<li>MQTTProtocol_startPublish() is called by MQTTAsync_processCommand() in MQTTAsync.c.</li>
<li>Similar as Socket_new(), MQTTAsync_processCommand() is called by MQTTAsync_sendThread() defined in MQTTAsync.c. There are two threads created when start up. MQTTAsync_sendThread is one of them, and the other is MQTTAsync_receiveThread.</li>
</ul>
<hr>
<h4 id="Multi-threads-in-MQTTAsync"><a href="#Multi-threads-in-MQTTAsync" class="headerlink" title="Multi-threads in MQTTAsync"></a><strong>Multi-threads in MQTTAsync</strong></h4><p>There’s a commands list (a linked list) created at startup. This commands list could be inserted with commands by MQTTAsync_addCommand(). MQTTAsync_addCommand() is called in multiple conditions. For example, one condition where MQTTAsync_send() is called by an application, the command initiated by the application will be inserted into the command list and will be processed by MQTTAsync_processCommand().</p>
<p>It’s observable that the commands list is shared between the main thread and the MQTTAsync_sendThread as MQTTAsync_processCommand() is called within this thread. The way to synchronize both threads is based on a signal condition namely <em>send_cond</em>, and a mutex namely <em>mqttcommand_mutex</em>.</p>
<p>As for MQTTAsync_receiveThread(), we could know:</p>
<ul>
<li>We need to specify a callback when message is arrived. This callback would be called by MQTTAsync_deliverMessage().</li>
<li>MQTTAsync_deliverMessage() is called by MQTTAsync_receiveThread() in the condition where the rc set by <em>MQTTAsync_cycle(&amp;sock, timeout, &amp;rc);</em> does not equal to SOCKET_ERROR.</li>
<li>Tracing back, we could find an instance of <em>MQTTAsyncs</em> structure type which has a client pointer which points to a message buffer. The code snippet is shown below:</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (m-&gt;c-&gt;messageQueue-&gt;count &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  qEntry* qe = (qEntry*)(m-&gt;c-&gt;messageQueue-&gt;first-&gt;content);</span><br><span class="line">  <span class="keyword">int</span> topicLen = qe-&gt;topicLen;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(qe-&gt;topicName) == topicLen)</span><br><span class="line">    topicLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (m-&gt;ma)</span><br><span class="line">    rc = MQTTAsync_deliverMessage(m, qe-&gt;topicName, topicLen, qe-&gt;msg);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    rc = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (rc)</span><br><span class="line">  &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(NO_PERSISTENCE)</span></span><br><span class="line">    <span class="keyword">if</span> (m-&gt;c-&gt;persistence)</span><br><span class="line">      MQTTPersistence_unpersistQueueEntry(m-&gt;c, (MQTTPersistence_qEntry*)qe);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ListRemove(m-&gt;c-&gt;messageQueue, qe); <span class="comment">/* qe is freed here */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    Log(TRACE_MIN, <span class="number">-1</span>, <span class="string">"False returned from messageArrived for client %s, message remains on queue"</span>,</span><br><span class="line">      m-&gt;c-&gt;clientID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>There is a shared buffer storing the incoming MQTT messages. It looks a bit complicated as QoS is involved, but the basic concept is to run MQTTAsync_cycle() once to read from sockets then call the registered callback in the app layer. A mutex namely mqttasync_mutex is used to protect the shared buffer.</li>
<li>For the timeout of sendThread, it has been set in Thread_wait_cond(), which is 1 second.</li>
<li>For the timeout of receiveThread, it could eventually calls MQTTAsync_sleep() with value of 100 milliseconds.</li>
</ul>
<hr>
<h4 id="Ember-Application-Framework"><a href="#Ember-Application-Framework" class="headerlink" title="Ember Application Framework"></a><strong>Ember Application Framework</strong></h4><p>The application Z3GatewayHost could be running on a Linux machine. It could also be equipped with a MQTT client and talks to a MQTT broker using the APIs defined in UG129. The MQTT client is based on paho.mqtt.c library, which invokes two threads (total three considering the main thread) when executing. It’s nature to wonder how to integrate a multi-threaded library into the Ember application framework without destroying anything. The answer is quite straightforward. In short, multi-threads won’t interfere anything in the Ember framework.</p>
<p>Z3GatewayHost is a process which forks a child process to handle UART comm. <em>paho.mqtt.c</em> creates two thread when startup, and such a creation is done during the framework’s initialization. Since the command to be sent to MQTT server is queued up in a shared buffer, the main thread (where ember framework runs) could send and exit in a non-blocking behavior. This is critical to the framework as ember stack error may happen if blocking operations are conducted. On the other hand, if the MQTT message from the broker is a <em>command</em> type, it will call the handleCommandMessage() handler, and add this command to a command list. This also prevents a blocking execution of a command. A looped event (20 milliseconds’ period) pops a command from the list and send the command through ezsp or internal handlers.</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Tony</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/TonyZhaoyu/" title="GitHub &rarr; https://github.com/TonyZhaoyu/" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tony</span>

  

  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  

  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  



  





  

  

  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


  

</body>
</html>
